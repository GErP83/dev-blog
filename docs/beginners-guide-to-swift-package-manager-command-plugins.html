<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Beginner's guide to Swift package manager command plugins - The.Swift.Dev.</title>
    
    <meta name="description" content="Learn how to create command plugins for the Swift Package Manager to execute custom actions using SPM and other tools.">
    
    <meta property="og:title" content="Beginner's guide to Swift package manager command plugins - The.Swift.Dev.">
    <meta property="og:description" content="Learn how to create command plugins for the Swift Package Manager to execute custom actions using SPM and other tools.">
    <meta property="og:url" content="https://theswiftdev.com/beginners-guide-to-swift-package-manager-command-plugins">
    <meta property="og:image" content="https://theswiftdev.com/images/assets/beginners-guide-to-swift-package-manager-command-plugins/cover.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@tiborbodecs">
    <meta name="twitter:creator" content="@tiborbodecs">
    <meta name="twitter:title" content="Beginner's guide to Swift package manager command plugins - The.Swift.Dev.">
    <meta name="twitter:description" content="Learn how to create command plugins for the Swift Package Manager to execute custom actions using SPM and other tools.">
    <meta name="twitter:image" content="https://theswiftdev.com/images/assets/beginners-guide-to-swift-package-manager-command-plugins/cover.jpg">
    
    <link rel="stylesheet" href="https://theswiftdev.com/css/style.css">
    <link rel="stylesheet" href="https://theswiftdev.com/css/syntax.css">
    
    <link rel="mask-icon" sizes="any" href="https://theswiftdev.com/images/icons/icon.svg">

    <link rel="shortcut icon" href="https://theswiftdev.com/images/icons/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="https://theswiftdev.com/images/icons/icon-320.png" type="image/png">
    
    <link rel="apple-touch-icon" href="https://theswiftdev.com/images/icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="57x57" href="https://theswiftdev.com/images/icons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://theswiftdev.com/images/icons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://theswiftdev.com/images/icons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://theswiftdev.com/images/icons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://theswiftdev.com/images/icons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://theswiftdev.com/images/icons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://theswiftdev.com/images/icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://theswiftdev.com/images/icons/apple-touch-icon-180x180.png">
    
</head>

<body>
    <a href="https://theswiftdev.gumroad.com" class="ribbon">
        📖
    </a>
    <header id="page-header">
        <a href="https://theswiftdev.com/">
            <img 
                id="logo-image"
                src="https://theswiftdev.com/images/icons/icon-320.png"
                alt="Logo of The.Swift.Dev." 
                title="The.Swift.Dev."
            >
        </a>
    </header>
    
    <main>

        <article>
    <header>
        <section id="post-header" class="content-wrapper">
            <time datetime="2022/05/16">2022/05/16</time>
            <h1 class="title">Beginner's guide to Swift package manager command plugins</h1>
            <p class="excerpt">Learn how to create command plugins for the Swift Package Manager to execute custom actions using SPM and other tools.</p>
            <div class="meta">
                <span class="tag">Swift</span>
<span class="tag">SPM</span>
            </div>
        </section>
        <section class="wrapper">
            <img id="post-image" src="https://theswiftdev.com/images/assets/beginners-guide-to-swift-package-manager-command-plugins/cover.jpg">
        </section>
    </header>

    <div id="contents">
        <section class="content-wrapper">
            <h2>Introduction to Swift Package Manager plugins</h2><p>First of all I'd like to talk a few words about the new SPM plugin infrastructure, that was introduced in the Swift 5.6 release. The very <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0303-swiftpm-extensible-build-tools.md" target="_blank">first proposal</a> describes the detailed design of the plugin API with some <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0303-swiftpm-extensible-build-tools.md#example-1-swiftgen" target="_blank">plugin examples</a>, which are quite handy. Honestly speaking I was a bit to lazy to carefully read through the entire documentation, it's quite long, but long story short, you can create the following plugin types with the currently existing APIs:</p><ul><li>Build tools - can be invoked via the SPM targets<ul><li>pre-build - runs before the build starts</li><li>build - runs during the build</li></ul></li><li>Commands - can be invoked via the command line<ul><li>source code formatting - modifies the code inside package</li><li>documentation generation - generate docs for the package</li><li>custom - user defined intentions</li></ul></li></ul><p>For the sake of simplicity in this tutorial I'm only going to write a bit about the second category, aka. the command plugins. These plugins were a bit more interesting for me, because I wanted to integrate my deployment workflow into SPM, so I started to experiment with the plugin API to see how hard it is to build such a thing. Turns out it's quite easy, but the developer experience it's not that good. 😅</p><h2>Building a source code formatting plugin</h2><p>The very first thing I wanted to integrate with SPM was <a href="https://github.com/realm/SwiftLint" target="_blank">SwiftLint</a>, since I was not able to find a plugin implementation that I could use I started from scratch. As a starting point I was using the <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0332-swiftpm-command-plugins.md#example-2-formatting-source-code" target="_blank">example code</a> from the <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0332-swiftpm-command-plugins.md" target="_blank">Package Manager Command Plugins proposal</a>.</p><pre><code>mkdir Example
cd Example
swift package init --type=library
</code></pre><p>I started with a brand new package, using the swift package init command, then I modified the Package.swift file according to the documentation. I've also added <a href="https://github.com/realm/SwiftLint" target="_blank">SwiftLint</a> as a package dependency so SPM can download &amp; build the and hopefully my custom plugin command can invoke the swiftlint executable when it is needed.</p><pre><code class="language-swift"><span class="comment">// swift-tools-version: 5.6</span>
<span class="keyword">import</span> PackageDescription

<span class="keyword">let</span> package = <span class="type">Package</span>(
    name: <span class="string">"Example"</span>,
    platforms: [
        .<span class="call">macOS</span>(.<span class="dotAccess">v10_15</span>),
    ],
    products: [
        .<span class="call">library</span>(name: <span class="string">"Example"</span>, targets: [<span class="string">"Example"</span>]),
        .<span class="call">plugin</span>(name: <span class="string">"MyCommandPlugin"</span>, targets: [<span class="string">"MyCommandPlugin"</span>]),
    ],
    dependencies: [
        .<span class="call">package</span>(url: <span class="string">"https://github.com/realm/SwiftLint"</span>, branch: <span class="string">"master"</span>),
    ],
    targets: [
        .<span class="call">target</span>(name: <span class="string">"Example"</span>, dependencies: []),
        .<span class="call">testTarget</span>(name: <span class="string">"ExampleTests"</span>, dependencies: [<span class="string">"Example"</span>]),
       
        .<span class="call">plugin</span>(name: <span class="string">"MyCommandPlugin"</span>,
                capability: .<span class="call">command</span>(
                    intent: .<span class="call">sourceCodeFormatting</span>(),
                    permissions: [
                        .<span class="call">writeToPackageDirectory</span>(reason: <span class="string">"This command reformats source files"</span>)
                    ]
                ),
                dependencies: [
                    .<span class="call">product</span>(name: <span class="string">"swiftlint"</span>, package: <span class="string">"SwiftLint"</span>),
                ]),
    ]
)</code></pre><p>I've created a <code>Plugins</code> directory with a <code>main.swift</code> file right next to the Sources folder, with the following contents.</p><pre><code class="language-swift"><span class="keyword">import</span> PackagePlugin
<span class="keyword">import</span> Foundation

<span class="keyword">@main
struct</span> MyCommandPlugin: <span class="type">CommandPlugin</span> {
    
    <span class="keyword">func</span> performCommand(context: <span class="type">PluginContext</span>, arguments: [<span class="type">String</span>]) <span class="keyword">throws</span> {
        <span class="keyword">let</span> tool = <span class="keyword">try</span> context.<span class="call">tool</span>(named: <span class="string">"swiftlint"</span>)
        <span class="keyword">let</span> toolUrl = <span class="type">URL</span>(fileURLWithPath: tool.<span class="property">path</span>.<span class="property">string</span>)
        
        <span class="keyword">for</span> target <span class="keyword">in</span> context.<span class="property">package</span>.<span class="property">targets</span> {
            <span class="keyword">guard let</span> target = target <span class="keyword">as</span>? <span class="type">SourceModuleTarget</span> <span class="keyword">else</span> { <span class="keyword">continue</span> }

            <span class="keyword">let</span> process = <span class="type">Process</span>()
            process.<span class="property">executableURL</span> = toolUrl
            process.<span class="property">arguments</span> = [
                <span class="string">"</span>\(target.<span class="property">directory</span>)<span class="string">"</span>,
                <span class="string">"--fix"</span>,
               <span class="comment">// "--in-process-sourcekit" // this line will fix the issues...</span>
            ]

            <span class="keyword">try</span> process.<span class="call">run</span>()
            process.<span class="call">waitUntilExit</span>()
            
            <span class="keyword">if</span> process.<span class="property">terminationReason</span> == .<span class="dotAccess">exit</span> &amp;&amp; process.<span class="property">terminationStatus</span> == <span class="number">0</span> {
                <span class="call">print</span>(<span class="string">"Formatted the source code in</span> \(target.<span class="property">directory</span>)<span class="string">."</span>)
            }
            <span class="keyword">else</span> {
                <span class="keyword">let</span> problem = <span class="string">"</span>\(process.<span class="property">terminationReason</span>)<span class="string">:</span>\(process.<span class="property">terminationStatus</span>)<span class="string">"</span>
                <span class="type">Diagnostics</span>.<span class="call">error</span>(<span class="string">"swift-format invocation failed:</span> \(problem)<span class="string">"</span>)
            }
        }
    }
}</code></pre><p>The snippet above should locate the swiftlint tool using the plugins context then it'll iterate through the available package targets, filter out non source-module targets and format only those targets that contains actual Swift source files. The process object should simply invoke the underlying tool, we can wait until the child (swiftlint invocation) process exists and hopefully we're good to go. 🤞</p><p class="note">Update: <a href="https://twitter.com/k_alweheshy" target="_blank">kalKarmaDev</a> told me that it is possible to pass the <code>--in-process-sourcekit</code> argument to SwiftLint, this will fix the underlying issue and the source files are actually fixed.</p><p>I wanted to list the available plugins &amp; run my source code linter / formatter using the following shell commands, but unfortunately seems like the swiftlint invocation part failed for some strange reason.</p><pre><code class="language-sh">swift package plugin --list
swift package format-source-code #won't work, needs access to source files
swift package --allow-writing-to-package-directory format-source-code

# error: swift-format invocation failed: NSTaskTerminationReason(rawValue: 2):5
# what the hell happened? 🤔
</code></pre><p>Seems like there's a problem with the exit code of the invoked swiftlint process, so I removed the success check from the plugin source to see if that's causing the issue or not also tried to print out the executable command to debug the underlying problem.</p><pre><code class="language-swift"><span class="keyword">import</span> PackagePlugin
<span class="keyword">import</span> Foundation

<span class="keyword">@main
struct</span> MyCommandPlugin: <span class="type">CommandPlugin</span> {
    
    <span class="keyword">func</span> performCommand(context: <span class="type">PluginContext</span>, arguments: [<span class="type">String</span>]) <span class="keyword">throws</span> {
        <span class="keyword">let</span> tool = <span class="keyword">try</span> context.<span class="call">tool</span>(named: <span class="string">"swiftlint"</span>)
        <span class="keyword">let</span> toolUrl = <span class="type">URL</span>(fileURLWithPath: tool.<span class="property">path</span>.<span class="property">string</span>)
        
        <span class="keyword">for</span> target <span class="keyword">in</span> context.<span class="property">package</span>.<span class="property">targets</span> {
            <span class="keyword">guard let</span> target = target <span class="keyword">as</span>? <span class="type">SourceModuleTarget</span> <span class="keyword">else</span> { <span class="keyword">continue</span> }

            <span class="keyword">let</span> process = <span class="type">Process</span>()
            process.<span class="property">executableURL</span> = toolUrl
            process.<span class="property">arguments</span> = [
                <span class="string">"</span>\(target.<span class="property">directory</span>)<span class="string">"</span>,
                <span class="string">"--fix"</span>,
            ]

            <span class="call">print</span>(toolUrl.<span class="property">path</span>, process.<span class="property">arguments</span>!.<span class="call">joined</span>(separator: <span class="string">" "</span>))

            <span class="keyword">try</span> process.<span class="call">run</span>()
            process.<span class="call">waitUntilExit</span>()
        }
    }
}</code></pre><p>Intentionally made a small "mistake" in the Example.swift source file, so I can see if the swiftlint --fix command will solve this issue or not. 🤔</p><pre><code class="language-swift"><span class="keyword">public struct</span> Example {
    <span class="keyword">public private(set) var</span> text = <span class="string">"Hello, World!"</span>

    <span class="keyword">public init</span>() {
        <span class="keyword">let</span> xxx :<span class="type">Int</span> = <span class="number">123</span>
    }
}</code></pre><p>Turns out, when I run the plugin via the <a href="https://developer.apple.com/documentation/foundation/process" target="_blank">Process</a> invocation, nothing happens, but when I enter the following code manually into the shell, it just works.</p><pre><code class="language-sh">/Users/tib/Example/.build/arm64-apple-macosx/debug/swiftlint /Users/tib/Example/Tests/Example --fix
/Users/tib/Example/.build/arm64-apple-macosx/debug/swiftlint /Users/tib/Example/Tests/ExampleTests --fix
</code></pre><p>All right, so we definitely have a problem here... I tried to get the standard output message and error message from the running process, seems like swiftlint runs, but something in the SPM infrastructure blocks the code changes in the package. After several hours of debugging I decided to give a shot to <a href="https://github.com/apple/swift-format" target="_blank">swift-format</a>, because that's what the official docs suggest. 🤷‍♂️</p><pre><code class="language-swift"><span class="comment">// swift-tools-version: 5.6</span>
<span class="keyword">import</span> PackageDescription

<span class="keyword">let</span> package = <span class="type">Package</span>(
    name: <span class="string">"Example"</span>,
    platforms: [
        .<span class="call">macOS</span>(.<span class="dotAccess">v10_15</span>),
    ],
    products: [
        .<span class="call">library</span>(name: <span class="string">"Example"</span>, targets: [<span class="string">"Example"</span>]),
        .<span class="call">plugin</span>(name: <span class="string">"MyCommandPlugin"</span>, targets: [<span class="string">"MyCommandPlugin"</span>]),
    ],
    dependencies: [
        .<span class="call">package</span>(url: <span class="string">"https://github.com/apple/swift-format"</span>, exact: <span class="string">"0.50600.1"</span>),
    ],
    targets: [
        .<span class="call">target</span>(name: <span class="string">"Example"</span>, dependencies: []),
        .<span class="call">testTarget</span>(name: <span class="string">"ExampleTests"</span>, dependencies: [<span class="string">"Example"</span>]),
       
        .<span class="call">plugin</span>(name: <span class="string">"MyCommandPlugin"</span>,
                capability: .<span class="call">command</span>(
                    intent: .<span class="call">sourceCodeFormatting</span>(),
                    permissions: [
                        .<span class="call">writeToPackageDirectory</span>(reason: <span class="string">"This command reformats source files"</span>)
                    ]
                ),
                dependencies: [
                    .<span class="call">product</span>(name: <span class="string">"swift-format"</span>, package: <span class="string">"swift-format"</span>),
                ]),
    ]
)</code></pre><p>Changed both the <code>Package.swift</code> file and the plugin source code, to make it work with swift-format.</p><pre><code class="language-swift"><span class="keyword">import</span> PackagePlugin
<span class="keyword">import</span> Foundation

<span class="keyword">@main
struct</span> MyCommandPlugin: <span class="type">CommandPlugin</span> {
    
    <span class="keyword">func</span> performCommand(context: <span class="type">PluginContext</span>, arguments: [<span class="type">String</span>]) <span class="keyword">throws</span> {
        <span class="keyword">let</span> swiftFormatTool = <span class="keyword">try</span> context.<span class="call">tool</span>(named: <span class="string">"swift-format"</span>)
        <span class="keyword">let</span> swiftFormatExec = <span class="type">URL</span>(fileURLWithPath: swiftFormatTool.<span class="property">path</span>.<span class="property">string</span>)
<span class="comment">//        let configFile = context.package.directory.appending(".swift-format.json")</span>
        
        <span class="keyword">for</span> target <span class="keyword">in</span> context.<span class="property">package</span>.<span class="property">targets</span> {
            <span class="keyword">guard let</span> target = target <span class="keyword">as</span>? <span class="type">SourceModuleTarget</span> <span class="keyword">else</span> { <span class="keyword">continue</span> }

            <span class="keyword">let</span> process = <span class="type">Process</span>()
            process.<span class="property">executableURL</span> = swiftFormatExec
            process.<span class="property">arguments</span> = [
<span class="comment">//                "--configuration", "\(configFile)",</span>
                <span class="string">"--in-place"</span>,
                <span class="string">"--recursive"</span>,
                <span class="string">"</span>\(target.<span class="property">directory</span>)<span class="string">"</span>,
            ]
            <span class="keyword">try</span> process.<span class="call">run</span>()
            process.<span class="call">waitUntilExit</span>()

            <span class="keyword">if</span> process.<span class="property">terminationReason</span> == .<span class="dotAccess">exit</span> &amp;&amp; process.<span class="property">terminationStatus</span> == <span class="number">0</span> {
                <span class="call">print</span>(<span class="string">"Formatted the source code in</span> \(target.<span class="property">directory</span>)<span class="string">."</span>)
            }
            <span class="keyword">else</span> {
                <span class="keyword">let</span> problem = <span class="string">"</span>\(process.<span class="property">terminationReason</span>)<span class="string">:</span>\(process.<span class="property">terminationStatus</span>)<span class="string">"</span>
                <span class="type">Diagnostics</span>.<span class="call">error</span>(<span class="string">"swift-format invocation failed:</span> \(problem)<span class="string">"</span>)
            }
        }
    }
}</code></pre><p>I tried to run again the exact same package plugin command to format my source files, but this time swift-format was doing the code formatting instead of swiftlint.</p><pre><code class="language-sh">swift package --allow-writing-to-package-directory format-source-code
// ... loading dependencies
Build complete! (6.38s)
Formatted the source code in /Users/tib/Linter/Tests/ExampleTests.
Formatted the source code in /Users/tib/Linter/Sources/Example.
</code></pre><p>Worked like a charm, my Example.swift file was fixed and the : was on the left side... 🎊</p><pre><code class="language-swift"><span class="keyword">public struct</span> Example {
    <span class="keyword">public private(set) var</span> text = <span class="string">"Hello, World!"</span>

    <span class="keyword">public init</span>() {
        <span class="keyword">let</span> xxx: <span class="type">Int</span> = <span class="number">123</span>
    }
}</code></pre><p>Yeah, I've made some progress, but it took me quite a lot of time to debug this issue and I don't like the fact that I have to mess around with processes to invoke other tools... my gut tells me that SwiftLint is not following the standard shell exit status codes and that's causing some issues, maybe it's spawning child processes and that's the problem, I really don't know but I don't wanted to waste more time on this issue, but I wanted to move forward with the other category. 😅</p><h2>Integrating the DocC plugin with SPM</h2><p>As a first step I added some dummy comments to my Example library to be able to see something in the generated documentation, nothing fancy just some one-liners. 📖</p><pre><code class="language-swift"><span class="comment">/// This is just an example struct</span>
<span class="keyword">public struct</span> Example {

    <span class="comment">/// this is the hello world text</span>
    <span class="keyword">public private(set) var</span> text = <span class="string">"Hello, World!"</span>
    
    <span class="comment">/// this is the init method</span>
    <span class="keyword">public init</span>() {
        <span class="keyword">let</span> xxx: <span class="type">Int</span> = <span class="number">123</span>
    }
}</code></pre><p>I discovered that Apple has an <a href="https://github.com/apple/swift-docc-plugin" target="_blank">official DocC plugin</a>, so I added it as a dependency to my project.</p><pre><code class="language-swift"><span class="comment">// swift-tools-version: 5.6</span>
<span class="keyword">import</span> PackageDescription

<span class="keyword">let</span> package = <span class="type">Package</span>(
    name: <span class="string">"Example"</span>,
    platforms: [
        .<span class="call">macOS</span>(.<span class="dotAccess">v10_15</span>),
    ],
    products: [
        .<span class="call">library</span>(name: <span class="string">"Example"</span>, targets: [<span class="string">"Example"</span>]),
        .<span class="call">plugin</span>(name: <span class="string">"MyCommandPlugin"</span>, targets: [<span class="string">"MyCommandPlugin"</span>]),
    ],
    dependencies: [
        .<span class="call">package</span>(url: <span class="string">"https://github.com/apple/swift-format"</span>, exact: <span class="string">"0.50600.1"</span>),
        .<span class="call">package</span>(url: <span class="string">"https://github.com/apple/swift-docc-plugin"</span>, from: <span class="string">"1.0.0"</span>),

    ],
    targets: [
        .<span class="call">target</span>(name: <span class="string">"Example"</span>, dependencies: []),
        .<span class="call">testTarget</span>(name: <span class="string">"ExampleTests"</span>, dependencies: [<span class="string">"Example"</span>]),
       
        .<span class="call">plugin</span>(name: <span class="string">"MyCommandPlugin"</span>,
                capability: .<span class="call">command</span>(
                    intent: .<span class="call">sourceCodeFormatting</span>(),
                    permissions: [
                        .<span class="call">writeToPackageDirectory</span>(reason: <span class="string">"This command reformats source files"</span>)
                    ]
                ),
                dependencies: [
                    .<span class="call">product</span>(name: <span class="string">"swift-format"</span>, package: <span class="string">"swift-format"</span>),
                ]),
    ]
)</code></pre><p>Two new plugin commands were available after I executed the plugin list command.</p><pre><code class="language-sh">swift package plugin --list

# ‘format-source-code’ (plugin ‘MyCommandPlugin’ in package ‘Example’)
# ‘generate-documentation’ (plugin ‘Swift-DocC’ in package ‘SwiftDocCPlugin’)
# ‘preview-documentation’ (plugin ‘Swift-DocC Preview’ in package ‘SwiftDocCPlugin’)
</code></pre><p>Tried to run the first one, and fortunately the doccarchive file was generated. 😊</p><pre><code class="language-sh">swift package generate-documentation
# Generating documentation for 'Example'...
# Build complete! (0.16s)
# Converting documentation...
# Conversion complete! (0.33s)
# Generated DocC archive at '/Users/tib/Linter/.build/plugins/Swift-DocC/outputs/Example.doccarchive'
</code></pre><p>Also tried to preview the documentation, there was a note about the --disable-sandbox flag in the output, so I simply added it to my original command and...</p><pre><code class="language-sh">swift package preview-documentation 
# Note: The Swift-DocC Preview plugin requires passing the '--disable-sandbox' flag
swift package --disable-sandbox preview-documentation
</code></pre><p>Magic. It worked and my documentation was available. Now this is how plugins should work, I loved this experience and I really hope that more and more official plugins are coming soon. 😍</p><h2>Building a custom intent command plugin</h2><p>I wanted to build a small executable target with some bundled resources and see if a plugin can deploy the executable binary with the resources. This could be very useful when I deploy feather apps, I have multiple module bundles there and now I have to manually copy everything... 🙈</p><pre><code class="language-swift"><span class="comment">// swift-tools-version: 5.6</span>
<span class="keyword">import</span> PackageDescription

<span class="keyword">let</span> package = <span class="type">Package</span>(
    name: <span class="string">"Example"</span>,
    platforms: [
        .<span class="call">macOS</span>(.<span class="dotAccess">v10_15</span>),
    ],
    products: [
        .<span class="call">library</span>(name: <span class="string">"Example"</span>, targets: [<span class="string">"Example"</span>]),
        .<span class="call">executable</span>(name: <span class="string">"MyExample"</span>, targets: [<span class="string">"MyExample"</span>]),
        .<span class="call">plugin</span>(name: <span class="string">"MyCommandPlugin"</span>, targets: [<span class="string">"MyCommandPlugin"</span>]),
        .<span class="call">plugin</span>(name: <span class="string">"MyDistCommandPlugin"</span>, targets: [<span class="string">"MyDistCommandPlugin"</span>]),
    ],
    dependencies: [
        .<span class="call">package</span>(url: <span class="string">"https://github.com/apple/swift-format"</span>, exact: <span class="string">"0.50600.1"</span>),
        .<span class="call">package</span>(url: <span class="string">"https://github.com/apple/swift-docc-plugin"</span>, from: <span class="string">"1.0.0"</span>),

    ],
    targets: [
        .<span class="call">executableTarget</span>(name: <span class="string">"MyExample"</span>,
                          resources: [
                            .<span class="call">copy</span>(<span class="string">"Resources"</span>),
                          ], plugins: [
                            
                          ]),
        .<span class="call">target</span>(name: <span class="string">"Example"</span>, dependencies: []),
        .<span class="call">testTarget</span>(name: <span class="string">"ExampleTests"</span>, dependencies: [<span class="string">"Example"</span>]),
       
        .<span class="call">plugin</span>(name: <span class="string">"MyCommandPlugin"</span>,
                capability: .<span class="call">command</span>(
                    intent: .<span class="call">sourceCodeFormatting</span>(),
                    permissions: [
                        .<span class="call">writeToPackageDirectory</span>(reason: <span class="string">"This command reformats source files"</span>)
                    ]
                ),
                dependencies: [
                    .<span class="call">product</span>(name: <span class="string">"swift-format"</span>, package: <span class="string">"swift-format"</span>),
                ]),
        
        .<span class="call">plugin</span>(name: <span class="string">"MyDistCommandPlugin"</span>,
                capability: .<span class="call">command</span>(
                    intent: .<span class="call">custom</span>(verb: <span class="string">"dist"</span>, description: <span class="string">"Create dist archive"</span>),
                    permissions: [
                        .<span class="call">writeToPackageDirectory</span>(reason: <span class="string">"This command deploys the executable"</span>)
                    ]
                ),
                dependencies: [
                ]),
    ]
)</code></pre><p>As a first step I created a new executable target called MyExample and a new MyDistCommandPlugin with a custom verb. Inside the Sources/MyExample/Resources folder I've placed a simple test.json file with the following contents.</p><pre><code class="language-json">{
    "success": true
}
</code></pre><p>The main.swift file of the MyExample target looks like this. It just validates that the resource file is available and it simply decodes the contents of it and prints everything to the standard output. 👍</p><pre><code class="language-swift"><span class="keyword">import</span> Foundation

<span class="keyword">guard let</span> jsonFile = <span class="type">Bundle</span>.<span class="property">module</span>.<span class="call">url</span>(forResource: <span class="string">"Resources/test"</span>, withExtension: <span class="string">"json"</span>) <span class="keyword">else</span> {
    <span class="call">fatalError</span>(<span class="string">"Bundle file not found"</span>)
}
<span class="keyword">let</span> jsonData = <span class="keyword">try</span> <span class="type">Data</span>(contentsOf: jsonFile)

<span class="keyword">struct</span> Json: <span class="type">Codable</span> {
    <span class="keyword">let</span> success: <span class="type">Bool</span>
}

<span class="keyword">let</span> json = <span class="keyword">try</span> <span class="type">JSONDecoder</span>().<span class="call">decode</span>(<span class="type">Json</span>.<span class="keyword">self</span>, from: jsonData)

<span class="call">print</span>(<span class="string">"Is success?"</span>, json.<span class="property">success</span>)</code></pre><p>Inside the Plugins folder I've created a main.swift file under the MyDistCommandPlugin folder.</p><pre><code class="language-swift"><span class="keyword">import</span> PackagePlugin
<span class="keyword">import</span> Foundation

<span class="keyword">@main
struct</span> MyDistCommandPlugin: <span class="type">CommandPlugin</span> {
    
    <span class="keyword">func</span> performCommand(context: <span class="type">PluginContext</span>, arguments: [<span class="type">String</span>]) <span class="keyword">throws</span> {
        
        <span class="comment">// ...</span>
    }
}</code></pre><p>Now I was able to re-run the swift package plugin --list command and the dist verb appeared in the list of available commands. Now the only question is: how do we get the artifacts out of the build directory? Fortunately the <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0332-swiftpm-command-plugins.md#example-3-building-deployment-artifacts" target="_blank">3rd example</a> of the commands proposal is quite similar.</p><pre><code class="language-swift"><span class="keyword">import</span> PackagePlugin
<span class="keyword">import</span> Foundation

<span class="keyword">@main
struct</span> MyDistCommandPlugin: <span class="type">CommandPlugin</span> {
    
    <span class="keyword">func</span> performCommand(context: <span class="type">PluginContext</span>, arguments: [<span class="type">String</span>]) <span class="keyword">throws</span> {
        <span class="keyword">let</span> cpTool = <span class="keyword">try</span> context.<span class="call">tool</span>(named: <span class="string">"cp"</span>)
        <span class="keyword">let</span> cpToolURL = <span class="type">URL</span>(fileURLWithPath: cpTool.<span class="property">path</span>.<span class="property">string</span>)

        <span class="keyword">let</span> result = <span class="keyword">try</span> packageManager.<span class="call">build</span>(.<span class="call">product</span>(<span class="string">"MyExample"</span>), parameters: .<span class="keyword">init</span>(configuration: .<span class="dotAccess">release</span>, logging: .<span class="dotAccess">concise</span>))
        <span class="keyword">guard</span> result.<span class="property">succeeded</span> <span class="keyword">else</span> {
            <span class="call">fatalError</span>(<span class="string">"couldn't build product"</span>)
        }
        <span class="keyword">guard let</span> executable = result.<span class="property">builtArtifacts</span>.<span class="call">first</span>(where : { $0.<span class="property">kind</span> == .<span class="dotAccess">executable</span> }) <span class="keyword">else</span> {
            <span class="call">fatalError</span>(<span class="string">"couldn't find executable"</span>)
        }
        
        <span class="keyword">let</span> process = <span class="keyword">try</span> <span class="type">Process</span>.<span class="call">run</span>(cpToolURL, arguments: [
            executable.<span class="property">path</span>.<span class="property">string</span>,
            context.<span class="property">package</span>.<span class="property">directory</span>.<span class="property">string</span>,
        ])
        process.<span class="call">waitUntilExit</span>()

        <span class="keyword">let</span> exeUrl = <span class="type">URL</span>(fileURLWithPath: executable.<span class="property">path</span>.<span class="property">string</span>).<span class="call">deletingLastPathComponent</span>()
        <span class="keyword">let</span> bundles = <span class="keyword">try</span> <span class="type">FileManager</span>.<span class="property">default</span>.<span class="call">contentsOfDirectory</span>(atPath: exeUrl.<span class="property">path</span>).<span class="call">filter</span> { $0.<span class="call">hasSuffix</span>(<span class="string">".bundle"</span>) }

        <span class="keyword">for</span> bundle <span class="keyword">in</span> bundles {
            <span class="keyword">let</span> process = <span class="keyword">try</span> <span class="type">Process</span>.<span class="call">run</span>(cpToolURL, arguments: [<span class="string">"-R"</span>,
                                                                    exeUrl.<span class="call">appendingPathComponent</span>(bundle).<span class="property">path</span>,
                                                                    context.<span class="property">package</span>.<span class="property">directory</span>.<span class="property">string</span>,
                                                                ])
            process.<span class="call">waitUntilExit</span>()
        }
    }
}</code></pre><p>So the only problem was that I was not able to get back the bundled resources, so I had to use the URL of the executable file, drop the last path component and read the contents of that directory using the FileManager to get back the .bundle packages inside of that folder.</p><p>Unfortunately the builtArtifacts property only returns the executables and libraries. I really hope that we're going to get support for bundles as well in the future so this hacky solution can be avoided for good. Anyway it works just fine, but still it's a hack, so use it carefully. ⚠️</p><pre><code class="language-sh">swift package --allow-writing-to-package-directory dist
./MyExample 
#Is success? true
</code></pre><p>I was able to run my custom dist command without further issues, of course you can use additional arguments to customize your plugin or add more flexibility, the examples in the proposal are pretty much okay, but it's quite unfortunate that there is no official documentation for Swift package manager plugins just yet. 😕</p><h2>Conclusion</h2><p>Learning about command plugins was fun, but in the beginning it was annoying because I expected a bit better developer experience regarding the tool invocation APIs. In summary I can say that this is just the beginning. It's just like the async / await and actors addition to the Swift language. The feature itself is there, it's mostly ready to go, but not many developers are using it on a daily basis. These things will require time and hopefully we're going to see a lot more plugins later on... 💪</p>
        </section>
    </div>

</article>

<section id="share" class="content-wrapper">
    <p>
    <a
        href="https://twitter.com/intent/tweet?via=tiborbodecs&amp;hashtags=SwiftLang&amp;url=https://theswiftdev.com/beginners-guide-to-swift-package-manager-command-plugins"
        target="_blank"
    >
        Share this article on Twitter
    </a>
    <br> Thank you. 🙏</p>
</section>

<section  class="wrapper">
    <div id="book">
        <div class="column left">
            <img src="https://theswiftdev.com/assets/book/vapor.png">
        </div>
        <div class="column right">
            <h3>Get the Practical Server Side Swift book</h3>
            <p>Swift on the server is an amazing new opportunity to build fast, safe and scalable backend apps. Write your very first web-based application by using your favorite programming language. Learn how to build a modular blog engine using the latest version of the Vapor 4 framework. This book will help you to design and create modern APIs that'll allow you to share code between the server side and iOS. Start becoming a full-stack Swift developer.</p>
            <a class="button" href="https://gumroad.com/l/practical-server-side-swift" target="_blank">Available on Gumroad</a>
        </div>
    </div>
</section>

<section id="author" class="content-wrapper">
    <img 
        id="author-image"
        src="https://theswiftdev.com/images/profiles/tiborbodecs.jpg"
        alt="Picture of Tibor Bödecs" 
        title="Tibor Bödecs"
    >
    <h3>Tibor Bödecs</h3>
    <p class="title">CEO @ <a href="https://binarybirds.com/">Binary Birds</a></p>
    <p class="bio">Server side Swift enthusiast, book author, content creator.</p>

    <div class="links">
        <a href="mailto:mail.tib@gmail.com?subject=theswiftdev.com" target="_blank">Email</a> · 
        <a href="https://twitter.com/tiborbodecs" target="_blank">Twitter</a> · 
        <a href="https://github.com/tib" target="_blank">GitHub</a> 
    </div>
</section>

        
    </main>

    <footer>
        <section class="content-wrapper">
            <img 
                src="https://theswiftdev.com/images/icons/icon-320.png"
                alt="Logo of The.Swift.Dev." 
                title="The.Swift.Dev."
            >

            <p>This site was generated using the <a href="https://swift.org/" target="_blank">Swift</a> programming language.</p>
            
            <p> 
                <a href="https://theswiftdev.com/">Home</a> ·
                <a href="https://theswiftdev.com/rss.xml" target="_blank">RSS</a> ·
                <a href="https://theswiftdev.com/sitemap.xml" target="_blank">Sitemap</a>
            </p>
            
            <p class="small">Created by Tibor Bödecs &copy; 2015 - 2023.</p>
        </section>
    </footer>
</body>
</html>
